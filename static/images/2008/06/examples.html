<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.4: http://docutils.sourceforge.net/" />
<title>Examples for my ZODB Talk</title>
<meta name="author" content="Kevin Dangoor" />
<meta name="date" content="July 3, 2008" />
<style type="text/css">

/*
:Author: David Goodger
:Contact: goodger@users.sourceforge.net
:Date: $Date: 2005-12-18 01:56:14 +0100 (Sun, 18 Dec 2005) $
:Revision: $Revision: 4224 $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin-left: 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left {
  clear: left }

img.align-right {
  clear: right }

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font-family: serif ;
  font-size: 100% }

pre.literal-block, pre.doctest-block {
  margin-left: 2em ;
  margin-right: 2em ;
  background-color: #eeeeee }

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

tt.docutils {
  background-color: #eeeeee }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document" id="examples-for-my-zodb-talk">
<h1 class="title">Examples for my ZODB Talk</h1>
<table class="docinfo" frame="void" rules="none">
<col class="docinfo-name" />
<col class="docinfo-content" />
<tbody valign="top">
<tr><th class="docinfo-name">Author:</th>
<td>Kevin Dangoor</td></tr>
<tr><th class="docinfo-name">Date:</th>
<td>July 3, 2008</td></tr>
</tbody>
</table>
<p>The example code comes from yachts.py and test_yachts.py. The code in here is used
for illustration and is incomplete. Look in the other files.</p>
<p>Let's start with the imports:</p>
<pre class="literal-block">
# &lt;== include('yachts.py', 'imports') ==&gt;
# The ZODB package provides us with a FileStorage which knows how to
# store the data (this is the one that most people use), and a DB
# object that provides access to the database.
from ZODB import FileStorage, DB

# persistent gives us a base class that helps detect changes in
# persistent objects.
from persistent import Persistent
from persistent.list import PersistentList

# transaction gives us the tools to handle atomic transactions
# in the ZODB (ZODB is ACID compliant).
import transaction

# the Standalone ZCatalog package
from zcatalog import catalog
from zcatalog import indexes

# &lt;==end==&gt;
</pre>
<p>Now, we connect to the database:</p>
<pre class="literal-block">
# &lt;== include('yachts.py', 'connect') ==&gt;
def connect(filename=&quot;yacht_data.zodb&quot;):
    &quot;&quot;&quot;Connects to the database and sets the root.&quot;&quot;&quot;
    global db, conn, root, last_filename
    last_filename = filename
    storage = FileStorage.FileStorage(filename)
    db = DB(storage)

    conn = db.open()
    root = conn.root()
# &lt;==end==&gt;
</pre>
<p>Let's define a customer object:</p>
<pre class="literal-block">
# &lt;== include('yachts.py', 'customer') ==&gt;
class Customer(Persistent):
    def __init__(self, name):
        self.name = name

    def __str__(self):
        return &quot;Customer: &quot; + self.name

    __repr__ = __str__
# &lt;==end==&gt;
</pre>
<p>First thing to note is that the ZODB is ACID-compliant. Let's add a customer:</p>
<pre class="literal-block">
# &lt;== include(&quot;test_yachts.py&quot;, &quot;add_customer&quot;) ==&gt;
root = get_root()
p = Customer(&quot;Josie MacGuffin&quot;)
root['customer'] = p
transaction.commit()
# &lt;==end==&gt;
</pre>
<p>Watch how we can abort a transaction:</p>
<pre class="literal-block">
# &lt;== include(&quot;test_yachts.py&quot;, &quot;acid_compliant&quot;) ==&gt;
p = Customer(&quot;Edward Snellmaster&quot;)
root['customer'] = p
transaction.abort()
assert root['customer'].name == &quot;Josie MacGuffin&quot;
# &lt;==end==&gt;
</pre>
<p>We want to have more than one customer, so let's keep them in a list:</p>
<pre class="literal-block">
# &lt;== include(&quot;test_yachts.py&quot;, &quot;customers_in_list&quot;) ==&gt;
del root['customer']
root['customers'] = []
root['customers'].append(Customer(random.choice(names)))
root['customers'].append(Customer(random.choice(names)))
transaction.commit()
root = reconnect()
assert len(root['customers']) == 2
# &lt;==end==&gt;
</pre>
<p>But wait, a list isn't Persistent:</p>
<pre class="literal-block">
# &lt;== include(&quot;test_yachts.py&quot;, &quot;problem_with_customers_in_a_list&quot;) ==&gt;
root['customers'].append(Customer(random.choice(names)))
assert len(root['customers']) == 3
root = reconnect()
assert len(root['customers']) == 2
# &lt;==end==&gt;
</pre>
<p>We should use a PersistentList object:</p>
<pre class="literal-block">
# &lt;== include(&quot;test_yachts.py&quot;, &quot;use_persistent_list&quot;) ==&gt;
current_customers = root['customers']
root['customers'] = PersistentList(current_customers)
transaction.commit()
root = reconnect()
assert len(root['customers']) == 2
root['customers'].append(Customer(random.choice(names)))
assert len(root['customers']) == 3
transaction.commit()

root = reconnect()
assert len(root['customers']) == 3
# &lt;==end==&gt;
</pre>
<p>Good to note that the ZODB is indeed not a relational database:</p>
<pre class="literal-block">
# &lt;== include(&quot;test_yachts.py&quot;, &quot;add_attribute&quot;) ==&gt;
customer = root['customers'][0]
customer.phone = &quot;555-1212&quot;
transaction.commit()
# &lt;==end==&gt;
</pre>
<p>You can create &quot;volatile&quot; attributes that you don't want persisted:</p>
<pre class="literal-block">
# &lt;== include(&quot;test_yachts.py&quot;, &quot;volatile&quot;) ==&gt;
customer = root['customers'][0]
customer._v_someval = 1
transaction.commit()
root = reconnect()
customer = root['customers'][0]
assert not hasattr(customer, &quot;_v_someval&quot;)
# &lt;==end==&gt;
</pre>
<p>Now, let's do something more complex. We're going to set things up so that
we can take orders for people's yachts. We'll start by defining the various
features that people can add:</p>
<pre class="literal-block">
# &lt;== include(&quot;yachts.py&quot;, &quot;features&quot;) ==&gt;
class Feature(Persistent):
    &quot;&quot;&quot;Describes a feature of the yacht.&quot;&quot;&quot;
    name = None
    price = None
    size = None

    def __init__(self, name, price, size):
        self.name = name
        self.price = price
        self.size = size

    def __str__(self):
        return &quot;%s (%s sq ft, $%s)&quot; % (self.name, self.size,
            locale.format(&quot;%d&quot;, self.price, True))

    __repr__ = __str__

DiningRoom = Feature(&quot;Dining Room&quot;, 100000, 200)
Bedroom = Feature(&quot;Bedroom&quot;, 50000, 100)
MasterSuite = Feature(&quot;Master Suite&quot;, 150000, 250)
HotTub = Feature(&quot;Hot Tub&quot;, 40000, 64)
Helipad = Feature(&quot;Helipad&quot;, 200000, 900)
SharksWithLasers = Feature(&quot;Sharks with Lasers&quot;, 1000000, 100)
# &lt;==end==&gt;
</pre>
<p>Here's the definition of an order for a Yacht:</p>
<pre class="literal-block">
# &lt;== include(&quot;yachts.py&quot;, &quot;yacht_main_part&quot;) ==&gt;
class Yacht(Persistent):
    def __init__(self, owner, name, size, price):
        for k, v in locals().items():
            setattr(self, k, v)
        self._features = []

    def __str__(self):
        output = [&quot;Yacht: %s&quot; % self.name]
        output.append(&quot;Owner: %s&quot; % (self.owner))
        output.append(&quot;Size (usable sq ft): %s&quot; % (self.size))
        output.append(&quot;Base price: $%s&quot; % (locale.format(&quot;%d&quot;, self.price, True)))
        output.append(&quot;Features:&quot;)
        total = self.price
        for feature in self._features:
            total += feature.price
            output.append(&quot;  %s&quot; % (feature))
        output.append(&quot;Total Cost: $%s&quot; % locale.format(&quot;%d&quot;, total, True))
        return &quot;\n&quot;.join(output)

# &lt;==end==&gt;
</pre>
<p>Here's an example of changing a mutable object. Specifically, when we change
that _features list on a Yacht:</p>
<pre class="literal-block">
# &lt;== include(&quot;yachts.py&quot;, &quot;add_feature&quot;) ==&gt;
def add_feature(self, feature):
    current_used = sum(feature.size for feature in self._features)
    if current_used + feature.size &gt; self.size:
        raise ValueError(&quot;Not enough space for %s&quot; % feature)

    self._features.append(feature)
    self._p_changed = True
# &lt;==end==&gt;
</pre>
<p>Let's see how you can make a Yacht, but only add as many features as will fit:</p>
<pre class="literal-block">
# &lt;== include(&quot;test_yachts.py&quot;, &quot;create_yacht&quot;) ==&gt;
root['orders'] = PersistentList()
customer = root['customers'][0]
order = Yacht(customer, &quot;Blustery Barnacles&quot;, 200, 100000)
root['orders'].append(order)
order.add_feature(Bedroom)
order.add_feature(SharksWithLasers)
try:
    order.add_feature(Helipad)
    assert False, &quot;Not enough space for a helipad&quot;
except ValueError:
    pass
# &lt;==end==&gt;
</pre>
<p>The ZODB is a true object database and handles object references just fine:</p>
<pre class="literal-block">
# &lt;== include(&quot;test_yachts.py&quot;, &quot;object_identity&quot;) ==&gt;
customer = root['customers'][0]
order = root['orders'][0]
assert customer is order.owner
# &lt;==end==&gt;
</pre>
<p>You can use __setstate__ to help with the equivalent of &quot;schema migration&quot;.
Note that changes made by setstate only actually persist if the object is
touched in some other fashion:</p>
<pre class="literal-block">
# &lt;== include(&quot;test_yachts.py&quot;, &quot;schema_migration&quot;) ==&gt;
customer = root['customers'][0]
Customer.__str__ = lambda self: &quot;%s (%s)&quot; % (self.name, self.email)
try:
    str(customer)
    assert False, &quot;Should have gotten attribute error, because email is new&quot;
except AttributeError:
    pass

# we can use __setstate__
def setstate(self, state):
    super(Customer, self).__setstate__(state)
    if 'email' not in state:
        self.email = &quot;none&quot;

Customer.__setstate__ = setstate

root = reconnect()
customer = root['customers'][0]
assert str(customer) == &quot;%s (none)&quot; % (customer.name), &quot;Customer: %s&quot; % (customer)
# &lt;==end==&gt;
</pre>
<p>You can do searches via standard Python list comprehensions. To do more
sophisticated searches, you need something more. Standalone ZCatalog
is one option. Let's create an index of our customers, with a full-text
index of their names:</p>
<pre class="literal-block">
# &lt;== include(&quot;yachts.py&quot;, &quot;create_catalog&quot;) ==&gt;
def create_catalog():
    root = get_root()
    if 'catalog' not in root:
        cat = catalog.Catalog()
        ti = indexes.TextIndex(field_name='name')
        cat['name'] = ti
        root['catalog'] = cat
    else:
        cat = root['catalog']
    for customer in root['customers']:
        cat.index_doc(customer)
# &lt;==end==&gt;
</pre>
<p>Let's try searching it:</p>
<pre class="literal-block">
# &lt;== include(&quot;test_yachts.py&quot;, &quot;searchtest&quot;) ==&gt;
customer = Customer(&quot;George Manfransinginsen&quot;)
root['customers'].append(customer)
create_catalog()
transaction.commit()
cat = root['catalog']
matches = list(cat.searchResults(name=&quot;Manfransinginsen&quot;))
assert customer in matches
# &lt;==end==&gt;
</pre>
<p>This works based on the BTrees package, so that it doesn't need to load
in all of the objects.</p>
<p>An alternative to ZCatalog is IndexedCatalog</p>
<p>Useful links:</p>
<ul class="simple">
<li>ZODB programming guide: <a class="reference" href="http://www.zope.org/Wikis/ZODB/guide/zodb.html">http://www.zope.org/Wikis/ZODB/guide/zodb.html</a></li>
<li>Standalone ZCatalog: <a class="reference" href="http://www.blazingthings.com/dev/zcatalog.html">http://www.blazingthings.com/dev/zcatalog.html</a></li>
<li>IndexedCatalog: <a class="reference" href="http://async.com.br/projects/indexedcatalog">http://async.com.br/projects/indexedcatalog</a></li>
</ul>
</div>
</body>
</html>
